import"./modulepreload-polyfill.b7f2da20.js";import{b as m}from"./basic.instanced.vert.c5f7cc12.js";import{p as w}from"./position.frag.e3ecd7bf.js";import{v as g,a as x}from"./cube.aa091a3d.js";import{b as P}from"./math.c29ca26c.js";import"./mat4.f7fc816f.js";async function B(e){if(!navigator.gpu)throw new Error("Not Support WebGPU");const o=await navigator.gpu.requestAdapter();if(!o)throw new Error("No Adapter Found");const a=await o.requestDevice(),i=e.getContext("webgpu"),r=navigator.gpu.getPreferredCanvasFormat?navigator.gpu.getPreferredCanvasFormat():i.getPreferredFormat(o),t=window.devicePixelRatio||1;e.width=e.clientWidth*t,e.height=e.clientHeight*t;const s={width:e.width,height:e.height};return i.configure({device:a,format:r,alphaMode:"opaque"}),{device:a,context:i,format:r,size:s}}async function b(e,o,a){const i=await e.createRenderPipelineAsync({label:"Basic Pipline",layout:"auto",vertex:{module:e.createShaderModule({code:m}),entryPoint:"main",buffers:[{arrayStride:20,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x2"}]}]},fragment:{module:e.createShaderModule({code:w}),entryPoint:"main",targets:[{format:o}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"}}),r=e.createTexture({size:a,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),t=r.createView(),s=e.createBuffer({label:"GPUBuffer store vertex",size:g.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(s,0,g);const c=e.createBuffer({label:"GPUBuffer store n*4x4 matrix",size:4*4*4*p,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),d=e.createBindGroup({label:"Uniform Group with matrix",layout:i.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:c}}]});return{pipeline:i,vertexBuffer:s,mvpBuffer:c,group:d,depthTexture:r,depthView:t}}function y(e,o,a){const i=e.createCommandEncoder(),r={colorAttachments:[{view:o.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:a.depthView,depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}},t=i.beginRenderPass(r);t.setPipeline(a.pipeline),t.setVertexBuffer(0,a.vertexBuffer),t.setBindGroup(0,a.group),t.draw(x,p),t.end(),e.queue.submit([i.finish()])}const p=500;async function T(){const e=document.querySelector("canvas");if(!e)throw new Error("No Canvas");const{device:o,context:a,format:i,size:r}=await B(e),t=await b(o,i,r);let s=r.width/r.height;const c=[],d=new Float32Array(p*4*4);for(let n=0;n<p;n++){const u={x:Math.random()*40-20,y:Math.random()*40-20,z:-50-Math.random()*50},f={x:0,y:0,z:0},h={x:1,y:1,z:1};c.push({position:u,rotation:f,scale:h})}function l(){for(let n=0;n<c.length-1;n++){const u=c[n],f=Date.now()/1e3;u.rotation.x=Math.sin(f+n),u.rotation.y=Math.cos(f+n);const h=P(s,u.position,u.rotation,u.scale);d.set(h,n*4*4)}o.queue.writeBuffer(t.mvpBuffer,0,d),y(o,a,t),requestAnimationFrame(l)}l(),window.addEventListener("resize",()=>{r.width=e.width=e.clientWidth*devicePixelRatio,r.height=e.height=e.clientHeight*devicePixelRatio,t.depthTexture.destroy(),t.depthTexture=o.createTexture({size:r,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}),t.depthView=t.depthTexture.createView(),s=r.width/r.height})}T();
